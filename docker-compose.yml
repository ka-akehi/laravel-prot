services:
    # ✅ 既存の Database Queue + Supervisor
    laravel-app:
        build: .
        container_name: laravel-app
        volumes:
            - .:/var/www/html
        working_dir: /var/www/html
        ports:
            - "8000:8000"
        command: php artisan serve --host=0.0.0.0 --port=8000

    # ✅ Redis Queue + Supervisor
    laravel-redis-worker:
        build: .
        container_name: laravel-redis-worker
        volumes:
            - .:/var/www/html
        working_dir: /var/www/html
        environment:
            - QUEUE_CONNECTION=redis
        depends_on:
            - redis

    # ✅ Redisサービス
    redis:
        image: redis:alpine
        container_name: redis
        ports:
            - "6379:6379"

    # ✅ Horizon 専用コンテナ（Supervisor起動）
    laravel-horizon:
        build:
            context: .
            dockerfile: Dockerfile.horizon
        volumes:
            - .:/var/www
        working_dir: /var/www
        environment:
            - QUEUE_CONNECTION=redis
        depends_on:
            - redis

    mysql:
        image: mysql:8.0
        container_name: mysql
        restart: always
        environment:
            - MYSQL_ROOT_PASSWORD=root
            - MYSQL_DATABASE=laravel
            - MYSQL_USER=laravel
            - MYSQL_PASSWORD=secret
        ports:
            - "3306:3306"
        volumes:
            - ./mysql_data:/var/lib/mysql

    phpmyadmin:
        image: phpmyadmin/phpmyadmin
        platform: linux/amd64
        ports:
            - "8080:80"
        environment:
            PMA_HOST: mysql
            MYSQL_ROOT_PASSWORD: root
