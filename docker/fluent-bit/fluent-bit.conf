[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Tag               laravel.logs
    Path              /var/log/laravel/*.log
    Refresh_Interval  5
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /fluent-bit/state/laravel.db

[INPUT]
    Name              tail
    Tag               next.logs
    Path              /var/log/nextjs/*.log
    Refresh_Interval  5
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /fluent-bit/state/nextjs.db
    Parser            ndjson

[INPUT]
    Name              dummy
    Tag               metrics.heartbeat
    Dummy             {"result":"__heartbeat__"}
    Rate              1

[FILTER]
    Name    record_modifier
    Match   laravel.logs
    Record  service  laravel-app

[FILTER]
    Name    record_modifier
    Match   next.logs
    Record  service  next-app

# 認証失敗イベントをメトリクス用タグに振り分ける
[FILTER]
    Name    rewrite_tag
    Match   next.logs
    Rule    result ^invalid-credentials$ metrics_next_invalid true
    Rule    result ^rate-limited$ metrics_next_invalid true

[FILTER]
    Name    rewrite_tag
    Match   metrics.heartbeat
    Rule    result ^__heartbeat__$ metrics_next_invalid true

# Luaフィルターで直近1分の失敗回数を保持する
[FILTER]
    Name    lua
    Match   metrics_next_invalid
    Script  /fluent-bit/etc/metrics_window.lua
    Call    count_per_minute

# 実イベントのみをカウンター用タグに複製
[FILTER]
    Name    rewrite_tag
    Match   metrics_next_invalid
    Rule    result ^(invalid-credentials|rate-limited)$ metrics_next_invalid_counter true

# 累計カウンターをメトリクス化する
[FILTER]
    Name            log_to_metrics
    Match           metrics_next_invalid_counter
    Metric_Name     next_invalid_auth_attempts_total
    Metric_Description 認証失敗イベントの累計回数
    Metric_Mode     counter
    Add_Label       service next-app
    Add_Label       result invalid-credentials
    Tag             metrics_prometheus

# 直近1分の失敗回数をメトリクス化する
[FILTER]
    Name            log_to_metrics
    Match           metrics_next_invalid
    Metric_Name     next_invalid_auth_attempts_per_minute
    Metric_Description 1分あたりの認証失敗回数
    Metric_Mode     gauge
    Value_Field     per_minute_count
    Add_Label       service next-app
    Add_Label       result invalid-credentials
    Tag             metrics_prometheus

[OUTPUT]
    Name   stdout
    Match  *.logs
    Format json_lines

# Prometheusエクスポーターでメトリクスを提供する
[OUTPUT]
    Name          prometheus_exporter
    Match         metrics_prometheus
    Host          0.0.0.0
    Port          2021
